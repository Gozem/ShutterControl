<!doctype html> 
<html>
<head>
<title>Websocket</title>
</head>
<body>
<h1>Websocket</h1>
<label id="conn_text"></label><br/>
<label id="Rain">Unknown</label><br/>
<label id="temp_1">Unknown</label><br/>
<label id="temp_2">Unknown</label><br/>
<label id="Shutter1">Unknown</label><br/>
<label id="Shutter2"></label><br/>
<label id="Shutter3"></label><br/>
<label id="Shutter4"></label><br/>
<label id="Shutter5"></label><br/>
<label id="Shutter6"></label><br/>
<br/>

<div>
  <button type="button" onclick="button('ANY', 'UP');"  >Any Up  </button><br/>
  <button type="button" onclick="button('ANY', 'DOWN');">Any Down</button><br/>
  <br/>
</div>

<div>
  <button type="button" onclick="button('ALL', 'UP');"  >All Up  </button><br/>
  <button type="button" onclick="button('ALL', 'DOWN');">All Down</button><br/>
  <br/>
</div>

<div>
  <button type="button" onclick="button('Shutter1', 'UP');"  >Up  </button><br/>
  <button type="button" onclick="button('Shutter1', 'STOP');">Stop</button><br/>
  <button type="button" onclick="button('Shutter1', 'DOWN');">Down</button><br/>
  <br/>
  <button type="button" onclick="button('Shutter1', 'FORCEUP');"  >ForceUp  </button><br/>
  <button type="button" onclick="button('Shutter1', 'FORCEDOWN');">ForceDown</button><br/>
</div>
<div id="messages_txt" />
<script>
    var ws = null;
    var conn_status = document.getElementById('conn_text');

    function start() {
      var loc = window.location;
      var uri = "ws://" + loc.host + "/ws";
      console.log("Connecting...");
      console.log(uri);
      conn_status.innerHTML = "Connection status: Connecting..."
      ws = new WebSocket(uri);

      ws.onopen = function(evt) {
        conn_status.innerHTML = "Connection status: Connected!"
      }

      ws.onmessage = function(event) {
        console.log("Status: " + event.data)

        var msg = JSON.parse(event.data)

        for (i = 1; i <= 6; i++) {
	  var name = "Shutter" + i;
	  if (msg[name]) {
	    var label = document.getElementById(name);
            label.innerHTML = name + " " + msg[name].state + " " + msg[name].busy
          }
          if (msg["Rain"]) {
	    var label = document.getElementById("Rain");
            label.innerHTML = msg["Rain"]
	 }
       
	}

        var newMessage = document.createElement('p');
        newMessage.textContent = "Server: " + event.data;
        document.getElementById('messages_txt').appendChild(newMessage);

        //var label_temp1 = document.getElementById('temp_1');
        //var label_temp2 = document.getElementById('temp_2');
        //current_temp = (evt.data).split(";");			
        //label_temp1.innerHTML = "Temp1: " + current_temp[0];                        
        //label_temp2.innerHTML = "Temp2: " + current_temp[1];


      };

      ws.onclose = function(event) {
        conn_status.innerHTML = "Connection status: Disconnected!"      
        check(); //Reconnect now
      };

      ws.onerror = function(error) {
        conn_status.innerHTML = "Connection status: Error: " + error;
        console.log("ERROR: " + error);
      }

  }

  function check() {
    if (!ws || ws.readyState == 3) start();
  }

    function button(shutter, cmd) {
      console.log("Button shutter: " + shutter + " cmd: " + cmd);
    
      var msg = {
        shutter: shutter,
        cmd: cmd
      };
      ws.send(JSON.stringify(msg));
    }

  start();
  setInterval(check, 3000);

</script>
</body></html>
